<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Teste Firebase Realtime Database</title>
</head>
<body>
  <h1>Teste de Conexão com Firebase Realtime Database</h1>

  <!-- Formulário para adicionar nova pessoa -->
  <h2>Adicionar Nova Pessoa</h2>
  <form id="addPessoaForm">
    <label for="nome">Nome:</label><br>
    <input type="text" id="nome" name="nome" required><br>
    <label for="idade">Idade:</label><br>
    <input type="number" id="idade" name="idade" required><br>
    <label for="email">Email:</label><br>
    <input type="email" id="email" name="email" required><br>
    <label for="telefone">Telefone:</label><br>
    <input type="text" id="telefone" name="telefone" required><br>
    <label for="endereco">Endereço:</label><br>
    <input type="text" id="endereco" name="endereco" required><br><br>
    <button type="submit">Adicionar Pessoa</button>
  </form>

  <!-- Botão para listar pessoas -->
  <h2>Lista de Pessoas</h2>
  <button onclick="listarPessoas()">Atualizar Lista</button>
  <div id="output"></div>

  <!-- Importar Firebase SDKs -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js';
    import { getDatabase, ref, set, get, remove } from 'https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js';

    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC2Zortaa5QFHDHbOUxrCr1fhIRvvtJ2DQ",
      authDomain: "minidatabase-bb5de.firebaseapp.com",
      databaseURL: "https://minidatabase-bb5de-default-rtdb.firebaseio.com",
      projectId: "minidatabase-bb5de",
      storageBucket: "minidatabase-bb5de.appspot.com",
      messagingSenderId: "468595906467",
      appId: "1:468595906467:web:d6b7215ba857cfe1ef2c16"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Função para adicionar uma nova pessoa
    async function adicionarPessoa() {
      const nome = document.getElementById('nome').value;
      const idade = document.getElementById('idade').value;
      const email = document.getElementById('email').value;
      const telefone = document.getElementById('telefone').value;
      const endereco = document.getElementById('endereco').value;

      try {
        // Referência para 'pessoas'
        const pessoasRef = ref(database, 'pessoas');

        // Obter os IDs existentes
        const snapshot = await get(pessoasRef);

        let newId = 1; // ID inicial

        if (snapshot.exists()) {
          const dados = snapshot.val();
          const ids = Object.keys(dados).map(id => parseInt(id)).filter(id => !isNaN(id));

          if (ids.length > 0) {
            const maxId = Math.max(...ids);
            newId = maxId + 1;
          }
        }

        // Adicionar a nova pessoa com o novo ID
        const pessoaRef = ref(database, 'pessoas/' + newId);
        await set(pessoaRef, {
          nome: nome,
          idade: parseInt(idade),
          email: email,
          telefone: telefone,
          endereco: endereco
        });

        alert('Pessoa adicionada com sucesso!');
        document.getElementById('addPessoaForm').reset();
        listarPessoas();

      } catch (error) {
        alert('Erro ao adicionar pessoa: ' + error.message);
      }
    }

    // Atualizar o evento de submissão do formulário
    document.getElementById('addPessoaForm').addEventListener('submit', function(e) {
      e.preventDefault();
      adicionarPessoa();
    });

    // Função para listar pessoas
    function listarPessoas() {
      const pessoasRef = ref(database, 'pessoas');
      get(pessoasRef).then((snapshot) => {
        if (snapshot.exists()) {
          const dados = snapshot.val();
          let output = '';
          for (let id in dados) {
            const pessoa = dados[id];
            output += `<div>
              <p>
                <strong>ID:</strong> ${id}<br>
                <strong>Nome:</strong> ${pessoa.nome}<br>
                <strong>Idade:</strong> ${pessoa.idade}<br>
                <strong>Email:</strong> ${pessoa.email}<br>
                <strong>Telefone:</strong> ${pessoa.telefone}<br>
                <strong>Endereço:</strong> ${pessoa.endereco}
              </p>
              <button onclick="removerPessoa('${id}')">Remover</button>
              <hr>
            </div>`;
          }
          document.getElementById("output").innerHTML = output;
        } else {
          document.getElementById("output").innerText = "Nenhum dado encontrado!";
        }
      }).catch((error) => {
        document.getElementById("output").innerText = "Erro ao ler dados: " + error.message;
      });
    }

    // Função para remover uma pessoa
    function removerPessoa(id) {
      if (confirm('Tem certeza que deseja remover esta pessoa?')) {
        remove(ref(database, 'pessoas/' + id))
        .then(() => {
          alert('Pessoa removida com sucesso!');
          listarPessoas();
        })
        .catch((error) => {
          alert('Erro ao remover pessoa: ' + error.message);
        });
      }
    }

    // Listar pessoas ao carregar a página
    window.onload = function() {
      listarPessoas();
    };
  </script>
</body>
</html>
